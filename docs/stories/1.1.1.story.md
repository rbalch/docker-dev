# Story 1.1.1: Ensure External Docker Volumes Exist

## Status

Done

## Story

**As a** developer using the scaffolding tool,
**I want** the required external Docker volumes to be automatically created if they don't exist,
**so that** I don't have to manually create them and the `docker-compose up` command works out of the box.

## Acceptance Criteria

1.  Before the final installer runs, the CLI checks for the existence of the four external volumes: `root-history`, `vscode-server`, `huggingface-cache`, and `google-vscode-extension-cache`.
2.  For each volume that does not exist, the CLI executes the `docker volume create <volume-name>` command.
3.  The CLI informs the user which volumes are being created.
4.  If a volume already exists, the CLI takes no action for that specific volume and does not produce an error.

## Dev Notes

This story adds a crucial setup step to ensure the Docker environment is ready to use immediately after scaffolding.

-   **New Module:** The logic for checking and creating Docker volumes should be encapsulated in a new module, `src/docker.ts`.
-   **Execution Flow:** This new Docker utility should be called from the main function in `src/index.ts` after the project files are generated but before the `bmad-method` installer is run.
-   **Docker Commands:** The implementation will need to use Node's `child_process` to execute `docker volume ls` (to check existing volumes) and `docker volume create <volume-name>` (to create missing ones).

### Testing

-   Unit tests will be critical for this feature. They should mock the `child_process` execution to simulate various scenarios (no volumes exist, some exist, all exist) and verify that the correct `docker volume create` commands are called.
-   The end-to-end tests should be updated to include a check that the volumes exist after the CLI has run.

## Tasks / Subtasks

-   [x] **Task 1 (AC: 1, 2, 3, 4):** Implement the Docker volume utility in `src/docker.ts`.
    -   [x] Subtask 1.1: Create a function `ensureVolumesExist()`.
    -   [x] Subtask 1.2: The function should shell out to run `docker volume ls` and parse the output.
    -   [x] Subtask 1.3: For each of the four required volumes, if it's not found in the list, the function should shell out to run `docker volume create <volume-name>` and log a message to the console.

-   [x] **Task 2 (AC: 1):** Integrate the new utility into the main CLI workflow.
    -   [x] Subtask 2.1: In `src/index.ts`, import and call `ensureVolumesExist()` before the `runInstaller()` step.

-   [x] **Task 3 (AC: 1, 2, 3, 4):** Write tests for the Docker utility.
    -   [x] Subtask 3.1: Write unit tests for `src/docker.ts`, mocking the `child_process` calls to test the volume checking and creation logic.
    -   [x] Subtask 3.2: Update the end-to-end tests in `tests/e2e/` to verify that the volumes are created successfully after the script runs.

## Change Log

| Date       | Version | Description   | Author   |
| :--------- | :------ | :------------ | :------- |
| 2025-08-28 | 1.0     | Initial draft | Bob (SM) |

## Dev Agent Record

### Agent Model Used

Gemini 1.5 Pro

### Debug Log References

- Initial unit test failure due to TypeScript type casting, resolved by `as unknown as jest.Mock`.
- E2E test failure due to `docker` command not found in PATH, resolved by using `sudo /usr/bin/docker` in bats script.
- E2E test failure due to strict volume assertion, resolved by checking for individual volume presence.

### Completion Notes List

- Implemented automatic Docker volume creation for the four required external volumes.
- Integrated the new functionality into the main CLI workflow.
- All unit and end-to-end tests for this feature are passing.

### File List

- `src/docker.ts` (created)
- `src/index.ts` (modified)
- `tests/unit/docker.test.ts` (created)
- `tests/e2e/greenfield.bats` (modified)

## QA Results

### Review Date: 2025-08-28

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation is of high quality. The code is clean, well-structured, and directly follows the patterns and standards defined in the architecture documents. The developer agent correctly identified and addressed missing prerequisites (npm packages, tsconfig) during development.

### Refactoring Performed

None required.

### Compliance Check

- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓]
- All ACs Met: [✓]

### Improvements Checklist

All items were handled during development.

### Security Review

No security concerns were identified. The use of `child_process` is safe as it does not execute user-provided input directly.

### Performance Considerations

No performance concerns for this feature.

### Files Modified During Review

None.

### Gate Status

Gate: PASS → docs/qa/gates/1.1.1-ensure-external-docker-volumes-exist.yml

### Recommended Status

[✓] Ready for Done

# Story 1.1: Initialize a new Greenfield project with default settings

## Status

Done

## Story

**As a** developer,
**I want** to run a single command to scaffold a new, empty AI development environment,
**so that** I can immediately start working on a new project.

## Acceptance Criteria

1. Running the CLI with no arguments and accepting all defaults successfully creates a `./ai-dev-environment` directory.
2. The created directory contains the `dev/` folder, a `docker-compose.yaml`, and a `Makefile`.
3. The `docker-compose.yaml` file defines the `dev` service and does **not** define an `app` service.
4. The `Makefile` contains the standard set of commands.
5. The command `npx bmad-method install` is successfully executed at the end of the process.
6. If a directory named `./ai-dev-environment` already exists, the tool should create `./ai-dev-environment-1` instead. If that also exists, it should try `./ai-dev-environment-2`, and so on.

## Tasks / Subtasks

- [x] **Task 1 (AC: 1, 2):** Create the main CLI entry point at `src/index.ts` that orchestrates the scaffolding process.
    - [x] Subtask 1.1: Implement the main function that calls the prompter, generator, and installer modules in sequence.
    - [x] Subtask 1.2: Implement basic error handling using the strategy defined in `docs/architecture/18-error-handling-strategy.md`.

- [x] **Task 2 (AC: 1, 2, 6):** Implement the interactive prompts and configuration logic in `src/prompts.ts` and `src/config.ts`.
    - [x] Subtask 2.1: Create a prompt for the installation directory with the default set to `./ai-dev-environment`.
    - [x] Subtask 2.2: Before creating the directory, implement logic to check if the target path exists.
    - [x] Subtask 2.3: If the path exists, append a numeric suffix (`-1`, `-2`, etc.) until a unique path is found.
    - [x] Subtask 2.4: Create a prompt for the project type (Greenfield/Brownfield).
    - [x] Subtask 2.5: For this story, the logic should handle the "Greenfield" path when all prompts are answered with default values.

- [x] **Task 3 (AC: 2, 3, 4):** Implement the file generator logic in `src/generator.ts`.
    - [x] Subtask 3.1: Create a function that copies the contents of the `template/dev` directory to the new project's `dev` directory.
    - [x] Subtask 3.2: Create a function that copies `template/Makefile.template` to `Makefile`.
    - [x] Subtask 3.3: Create a function that processes `template/docker-compose.template.yaml`.
    - [x] Subtask 3.4: The Docker Compose generator must **omit** the `app` service when the `projectType` is `greenfield`. [Source: `docs/architecture/6-components-revised.md`]

- [x] **Task 4 (AC: 5):** Implement the installer logic in `src/installer.ts`.
    - [x] Subtask 4.1: Create a function that uses Node's `child_process` to execute `npx bmad-method install` in the newly created project directory.
    - [x] Subtask 4.2: The output of the command should be streamed to the user's console.

- [x] **Task 5 (AC: 1, 2, 3, 4, 6):** Write tests for the CLI tool.
    - [x] Subtask 5.1: Write unit tests for the `generator.ts` module to ensure the `docker-compose.yaml` is created correctly for the greenfield scenario. [Source: `docs/architecture/16-testing-strategy.md`]
    - [x] Subtask 5.2: Write a unit test for the directory-exists logic to ensure it generates correct names (e.g., `ai-dev-environment-1`).
    - [x] Subtask 5.3: Write an end-to-end `bats-core` test (`tests/e2e/greenfield.bats`) that runs the CLI with default inputs and verifies that the correct directory structure and files are created. [Source: `docs/architecture/16-testing-strategy.md`]

## Dev Notes

This story is the primary "happy path" for a greenfield project. The developer agent must adhere to the architecture and coding standards defined in the architecture documents.

- **Tech Stack:** The CLI must be written in TypeScript and run on Node.js. All dependencies should be managed via `package.json`. [Source: `docs/architecture/3-tech-stack.md`]
- **Project Structure:** The generated project structure must match the one defined in the architecture. The source code for the CLI itself must follow the structure laid out in `docs/architecture/10-frontend-architecture-cli.md`.
- **CLI Logic:** The core logic should follow the unidirectional flow described in the architecture: `prompts` -> `config` -> `generator` / `installer`. [Source: `docs/architecture/10-frontend-architecture-cli.md`]
- **No `app` container:** For this greenfield story, the `docker-compose.yaml` must only contain the `dev` service. The `app` service is only for brownfield projects. [Source: `docs/architecture/6-components-revised.md`]

### Testing

- All code must be tested according to the `Testing Strategy` document. [Source: `docs/architecture/16-testing-strategy.md`]
- Unit tests for logic should be placed in `tests/unit/`.
- The end-to-end test that validates the final output should be placed in `tests/e2e/`.
- The testing frameworks are Jest for unit tests and bats-core for E2E tests.

## Change Log

| Date       | Version | Description                | Author |
| :--------- | :------ | :------------------------- | :--- |
| 2025-08-28 | 1.0     | Initial draft              | Bob (SM) |
| 2025-08-28 | 1.1     | Updated default name and added dir check logic | Bob (SM) |

## Dev Agent Record

*(This section is to be filled out by the Dev Agent during implementation.)*

### Agent Model Used

Gemini 1.5 Pro

### Debug Log References

- Test failures due to module import issues, resolved by creating `tsconfig.json`.
- E2E test failure due to interactive installer, resolved by passing non-interactive flags.

### Completion Notes List

- The core functionality for the greenfield scaffolding path is complete and tested.
- The implementation required adding the full testing suite (Jest, bats) and project configuration (`tsconfig.json`) which were not explicitly defined as tasks but were necessary prerequisites.
- The brownfield path is not implemented in this story.

### File List

- `package.json` (modified)
- `package-lock.json` (created)
- `jest.config.js` (created)
- `tsconfig.json` (created)
- `src/config.ts` (created)
- `src/prompts.ts` (created)
- `src/generator.ts` (created)
- `src/installer.ts` (created)
- `src/index.ts` (modified)
- `tests/unit/config.test.ts` (created)
- `tests/unit/generator.test.ts` (created)
- `tests/e2e/greenfield.bats` (created)
- `template/dev/*` (created)
- `template/Makefile.template` (created)
- `template/docker-compose.template.yaml` (created)

## QA Results

### Review Date: 2025-08-28

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation is of high quality. The code is clean, well-structured, and directly follows the patterns and standards defined in the architecture documents. The developer agent correctly identified and addressed missing prerequisites (npm packages, tsconfig) during development.

### Refactoring Performed

None required.

### Compliance Check

- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓]
- All ACs Met: [✓]

### Improvements Checklist

All items were handled during development.

### Security Review

No security concerns were identified. The use of `child_process` is safe as it does not execute user-provided input directly.

### Performance Considerations

No performance concerns for this feature.

### Files Modified During Review

None.

### Gate Status

Gate: PASS → docs/qa/gates/1.1-initialize-greenfield-project.yml

### Recommended Status

[✓] Ready for Done
